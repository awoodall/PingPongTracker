"use strict";function findTimeDiff(a,b){var c=new Date(a).getTime(),d=new Date(b).getTime(),e=d-c;e=Math.floor(e/1e3);var f=e%60;e=Math.floor(e/60);var g=e%60;e=Math.floor(e/60);var h=e%24;e=Math.floor(e/24);var i=h+":"+g+":"+f;return i}angular.module("pingPongTrackerApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]).controller("tracker",["$scope","$firebaseObject","$firebaseArray",function(a,b,c){var d=new Firebase("https://table-tennis-tracker.firebaseio.com/");a.dataObj=b(d),a.players=c(d.child("users")),a.selectedPlayer,a.currentPlayer,a.updateUser=function(){a.matchData="",a.currentPlayer=b(d.child("userData").child(a.selectedPlayer.$id)),a.matchArray=[];var e=c(d.child("userData").child(a.selectedPlayer.username).child("previousMatches"));e.$loaded().then(function(){for(var c=0,f=0;f<e.length;f++){a.matchArray.push(b(d.child("matches").child(e[f].$id)));var g=b(d.child("matches").child(e[f].$id));g.$loaded().then(function(){c+=a.currentPlayer.$id===g.p1?g.p1Score:g.p2Score,e.length-1<f&&d.child("userData").child(a.selectedPlayer.$id).update({totalScored:c})})}})},a.loadMatchTimeline=function(e){a.matchDataStartTime=b(d.child("matchData").child(e)),a.matchData=c(d.child("matchData").child(e).child("timeline"))},a.player1,a.player2,a.wfp=!1,a.gameReady=!1,a.matchStarted=!1,a.gameTimeline=b(d.child("currentMatch").child("timeline"));var e=0,f=0,g=b(d.child("currentMatch")),h=d.child("currentMatch"),i=d.child("currentMatch").child("timeline"),j=(b(d.child("matchData")),d.child("matchData"));a.waitingForPlayer=function(){a.player1&&a.player2?(a.wfp=!1,a.gameReady=!0):a.wfp=!0},a.startMatch=function(){a.matchStarted=!0,a.gameReady=!1,h.set({startTime:Firebase.ServerValue.TIMESTAMP,p1:a.player1.$id,p2:a.player2.$id,timeline:{}})},a.scored=function(b){b===a.player1.$id?(e++,console.log(e)):(f++,console.log(f)),e>=21&&e-f>=2||f>=21&&f-e>=2?(e>f?console.log("player 1 won!"):console.log("player 2 won!"),i.push().set({player:b,time:Firebase.ServerValue.TIMESTAMP}),h.child("endTime").set(Firebase.ServerValue.TIMESTAMP,function(){var b=findTimeDiff(g.startTime,g.endTime);h.on("value",function(c){var h=c.val().timeline,i=j.push({table:1,matchStart:g.startTime,matchEnd:g.endTime,timeline:h}),k=i.key();d.child("userData").child(a.player1.$id).child("previousMatches").child(k).set(!0),d.child("userData").child(a.player2.$id).child("previousMatches").child(k).set(!0),d.child("matches").child(k).set({duration:b,p1:a.player1.$id,p2:a.player2.$id,p1Score:e,p2Score:f}),a.wfp=!1,a.gameReady=!1,a.matchStarted=!1,a.player1="",a.player2=""})})):i.push().set({player:b,time:Firebase.ServerValue.TIMESTAMP})},a.findTimeDiff=function(a,b){var c=new Date(b).getTime(),d=new Date(a).getTime(),e=d-c;e=Math.floor(e/1e3);var f=e%60;e=Math.floor(e/60);var g=e%60;e=Math.floor(e/60);var h=e%24;e=Math.floor(e/24);var i=h+":"+g+":"+f;return i}}]);